


#!/bin/bash
# export JAVA_HOME=/usr/its/jdk1.8.0_65
# export PATH=$JAVA_HOME/bin:$PATH
# export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
# java -version

JAVA_OPTIONS="-Xms512M -Xmx512M -XX:+HeapDumpOnOutOfMemoryError"
PRJ_JAR=`ls kx-game*REL.jar`
PID=$(ps aux | grep ${PRJ_JAR} | grep -v grep | awk '{print $2}')

function check_if_process_is_running {
    if [ "$PID" = "" ]; then
        return 1
    fi
    ps -p $PID | grep "java" > /dev/null 2>&1
    return $?
}

function info {
    echo -e "\033[35m $1 \033[0m"
}

function wait5s {
    for i in {1..5}; do
        info ".\c"
        sleep 1
    done
    echo
}

function clean(){

	if [ ! -d "lastDeploy" ]; then
	   mkdir lastDeploy
	fi
	if [ -f "$PRJ_JAR" ]; then
	   
	   cp $PRJ_JAR lastDeploy/$PRJ_JAR`date +%Y%m%d%H%M%S`
	   cp -rf config  lastDeploy/config`date +%Y%m%d%H%M%S`
	   rm -rf $PRJ_JAR
           rm -rf config
           mv package/$PRJ_JAR .
           mv package/config .
	fi
}


case "$1" in
    status)
        if check_if_process_is_running
        then
            info "$PRJ_JAR is running"
        else
            info "$PRJ_JAR is not running"
        fi
        ;;
    stop)
        if check_if_process_is_running
        then
            kill -9 $PID
        fi
        info "$PRJ_JAR already stopped"
        ;;
    start)
        if check_if_process_is_running
        then
            info "$PRJ_JAR already running"
            exit 1
        fi
        nohup ./xjar java $JAVA_OPTIONS  -jar  $PRJ_JAR --spring.profiles.active=pro > /dev/null 2>&1 &
        info "Starting\c"
        # wait5s
        if check_if_process_is_running
        then
            info "$PRJ_JAR fail"
        else
            info "$PRJ_JAR start"
        fi
        ;;
    restart)
        $0 stop
        if [ $? = 1 ]
        then
            exit 1
        fi
        $0 start
        ;;
    startl)
        $0 start
        tail -f logs/data.log
        ;;
    restartl)
        $0 restart
        tail -f logs/data.log
        ;;
    deploy)
	clean
	;;
		
    *)
        echo "Usage: $0 {start|startl|stop|restart|restartl|status|deploy}"
        exit 1
esac

exit 0


